---
- hosts: namenode
  become: yes
  become_method: sudo
  environment:
    http_proxy: "{{ http_proxy | default() }}"
    https_proxy: "{{ https_proxy | default() }}"
    no_proxy: "{{ no_proxy | default() }}"

  pre_tasks:
    # XXX java.net.InetAddress.getLocalHost throws an exception without this
    - shell: echo "127.0.0.1 localhost {{ ansible_hostname }} {{ ansible_fqdn }}" > /etc/hosts
      changed_when: False
    # XXX the latest haddop2, with "status" patches, is not available in the official repo
    - file:
        path: /usr/local/etc/pkg/repos
        state: directory
        mode: 755
      changed_when: false
      when: "{{ ansible_os_family == 'FreeBSD' }}"
    - shell: "echo 'FreeBSD: { enabled:  no }' > /usr/local/etc/pkg/repos/FreeBSD.conf"
      changed_when: false
      when: "{{ ansible_os_family == 'FreeBSD' }}"
    - shell: "echo 'reallyenglish: { url: \"pkg+http://10.3.build.reallyenglish.com/${ABI}\", mirror_type: \"srv\", signature_type: \"none\", enabled:  yes }' > /usr/local/etc/pkg/repos/reallyenglish.conf"
      changed_when: false
      when: "{{ ansible_os_family == 'FreeBSD' }}"
  roles:
    - role: ansible-role-hadoop-namenode
  vars:
    hadoop_config:
      slaves: []
      core_site:
        -
          - name: dfs.journalnode.edits.dir
          - value: /var/db/journalnode
      hdfs_site:
        -
          - name: dfs.nameservices
          - value: mycluster
        - 
          - name: dfs.ha.namenodes.mycluster
          - value: namenode1,namenode2
        -
          - name: dfs.namenode.rpc-address.mycluster.namenode1
          - value: 192.168.84.101:8020
        -
          - name: dfs.namenode.rpc-address.mycluster.namenode2
          - value: 192.168.84.102:8020
        -
          - name: dfs.namenode.http-address.mycluster.namenode1
          - value: 192.168.84.101:5070
        -
          - name: dfs.namenode.http-address.mycluster.namenode2
          - value: 192.168.84.102:5070
        -
          - name: dfs.namenode.shared.edits.dir
          - value: qjournal://192.168.84.101:8485;192.168.84.102:8485;192.168.84.103:8485/mycluster
        -
          - name: dfs.client.failover.proxy.provider.mycluster
          - value: org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider
      yarn_site: []
      mapred_site: []
